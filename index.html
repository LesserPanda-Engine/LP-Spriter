<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spriter Scon Runtime</title>
</head>
<body>
  <script src="pixi.js"></script>
  <script src="spriter.js"></script>

  <canvas id="canvas"></canvas>

  <script>
    var renderDebugData = false;
    var renderDebugPose = false;

    var animTime = 0;
    var animRate = 1;
    var animRepeat = 2;

    var data = new spriter.Data();
    var pose = new spriter.Pose(data);

    function sconMiddleWare(res, next) {
      if (res.url.match(/\.scon$/)) {
          // console.log('%s is scon', res.url);
          var path = res.url.replace(/[^\/]*$/, '');
          var atlasUrl = res.url.replace(/\.scon$/, '.json');
          // console.log(atlasUrl);
          PIXI.loader.add(atlasUrl);
          loadScon(res.data);
        }
        next();
    }

    function loadScon(sconStr) {
      var scon = JSON.parse(sconStr);
      // Load scon data
      data.load(scon);

      // Set entity and animation
      var entityKeys = pose.getEntityKeys();
      pose.setEntity(entityKeys[0]);

      var animKeys = pose.getAnimKeys();
      pose.setAnim(animKeys[0]);
    }

    PIXI.loader
      .add('GreyGuy/player.scon')
      .after(sconMiddleWare)
      .once('complete', start)
      .load();

    function start() {
      var renderer = PIXI.autoDetectRenderer(600, 400, {
        view: document.querySelector('#canvas')
      });
      var stage = new PIXI.Container();

      var animation = new PIXI.Container();
      animation.scale.y = -1;
      animation.position.set(300, 300);
      animation.sprites = {};
      stage.addChild(animation);

      var prevTime = 0;
      function render(time) {
        // Delta time
        var dt = time - (prevTime || time);
        prevTime = time;

        // Update animation
        animTime += dt * animRate;

        var anim = pose.curAnim();
        if (anim && (animTime >= anim.length * animRepeat)) {
          var animKeys = pose.getAnimKeys();
          var animKey = animKeys[(animKeys.indexOf(pose.getAnim()) + 1) % animKeys.length];
          pose.setAnim(animKey);
          pose.setTime(0);
          animTime = 0;
        }

        pose.strike();

        pose.object_array.forEach(function(obj) {
          var folder = data.folder_array[obj.folder_index];
          var file = folder.file_array[obj.file_index];
          var spriteName = file.name;

          var sprite = animation.sprites[spriteName];
          if (!sprite) {
            sprite = new PIXI.Sprite.fromFrame(spriteName);
            sprite.anchor.set(0.5, 0.5);
            animation.addChild(sprite);
            animation.sprites[spriteName] = sprite;
          }

          // Apply transform
          var model = obj.world_space;
          sprite.position.set(model.position.x, model.position.y);
          sprite.rotation = model.rotation.rad;
          sprite.scale.set(model.scale.x, -model.scale.y);
          sprite.alpha = obj.alpha;
        });

        renderer.render(stage);

        requestAnimationFrame(render);
      }

      requestAnimationFrame(render);
    }
  </script>
</body>
</html>

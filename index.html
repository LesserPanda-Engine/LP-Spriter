<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spriter for LesserPanda</title>
</head>
<body>
  <script src="pixi.js"></script>
  <script src="spriter.js"></script>

  <canvas id="canvas"></canvas>

  <script>
    var renderDebugData = false;
    var renderDebugPose = false;

    var animTime = 0;
    var animRate = 1;
    var animRepeat = 2;

    function sconMiddleWare(res, next) {
      if (res.url.match(/\.scon$/)) {
          // console.log('%s is scon', res.url);
          var path = res.url.replace(/[^\/]*$/, '');
          var atlasUrl = res.url.replace(/\.scon$/, '.json');
          // console.log(atlasUrl);
          PIXI.loader.add(atlasUrl);
        }
        next();
    }

    function createSpriter(sconStr) {
      var scon = JSON.parse(sconStr);

      // Load scon data
      var data = new spriter.Data().load(scon);
      var pose = new spriter.Pose(data);

      // Set entity and animation
      var entityKeys = pose.getEntityKeys();
      pose.setEntity(entityKeys[0]);

      var animKeys = pose.getAnimKeys();
      pose.setAnim(animKeys[0]);

      return pose;
    }

    PIXI.loader
      .add('player.scon', 'GreyGuy/player.scon')
      .after(sconMiddleWare)
      .once('complete', start)
      .load();

    function start() {
      var renderer = PIXI.autoDetectRenderer(600, 400, {
        view: document.querySelector('#canvas')
      });
      var stage = new PIXI.Container();

      // Create and init a spriter object
      var greyGuy = createSpriter(PIXI.loader.resources['player.scon'].data);
      greyGuy.container.position.set(300, 300);
      stage.addChild(greyGuy.container);

      greyGuy.setAnim('idle');

      var prevTime = 0;
      function render(time) {
        requestAnimationFrame(render);

        // Delta time
        var dt = time - (prevTime || time);
        prevTime = time;

        // Update animation
        greyGuy.update(dt * animRate);
        greyGuy.strike();

        // Change animation
        // animTime += dt * animRate;
        // var anim = greyGuy.curAnim();
        // if (anim && (animTime >= anim.length * animRepeat)) {
        //   var animKeys = greyGuy.getAnimKeys();
        //   var animKey = animKeys[(animKeys.indexOf(greyGuy.getAnim()) + 1) % animKeys.length];
        //   greyGuy.setAnim(animKey);
        //   greyGuy.setTime(0);
        //   animTime = 0;
        // }

        renderer.render(stage);
      }

      requestAnimationFrame(render);
    }
  </script>
</body>
</html>
